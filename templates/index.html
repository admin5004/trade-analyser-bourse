<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Analyzer Pro V3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        :root { --primary: #4f46e5; --bg: #f8fafc; --card-bg: #ffffff; --text-main: #0f172a; --success: #10b981; --danger: #ef4444; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 0; }
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1.5rem; }
        .search-box { max-width: 600px; margin: 0 auto 2rem; position: relative; }
        .search-form { display: flex; gap: 10px; background: white; padding: 6px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        /* Style pour le d√©filement automatique des secteurs */
        .sector-ticker-container { margin-top: 1rem; overflow: hidden; white-space: nowrap; position: relative; background: transparent; padding: 5px 0; }
        .sector-ticker-inner { display: inline-block; animation: ticker 80s linear infinite; padding-left: 100%; }
        .sector-ticker-inner:hover { animation-play-state: paused; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        .sector-badge { display: inline-block; background: white; border: 1px solid var(--border); padding: 6px 14px; border-radius: 99px; font-size: 0.8rem; margin-right: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        input[type="text"] { flex: 1; border: none; padding: 12px 20px; outline: none; font-size: 1rem; }
        button.btn-search { background: var(--primary); color: white; border: none; padding: 12px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; }
        .card { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 1.5rem; }
        .col-8 { grid-column: span 8; } .col-4 { grid-column: span 4; } .col-12 { grid-column: span 12; }
        .badge { padding: 6px 14px; border-radius: 99px; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        .badge-buy { background: #ecfdf5; color: var(--success); } .badge-sell { background: #fef2f2; color: var(--danger); }
        .stat-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .stat-label { color: #64748b; } .stat-val { font-weight: 700; }
        .accordion-btn { width: 100%; padding: 15px; background: #0f172a; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 1rem; }
        .accordion-content { display: none; margin-top: 1rem; background: white; border-radius: 20px; border: 1px solid var(--border); padding: 1rem; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding: 1rem; }
        .heatmap-tile { text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70px; border-radius: 12px; color: white; font-weight: 800; font-size: 0.85rem; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .heatmap-tile:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        
        /* Style des boutons de p√©riode du graphique */
        .chart-controls { display: flex; flex-direction: column; gap: 8px; padding-right: 15px; border-right: 1px solid var(--border); }
        .btn-period { background: white; border: 1px solid var(--border); color: var(--text-main); padding: 8px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s; min-width: 50px; }
        .btn-period:hover { border-color: var(--primary); color: var(--primary); }
        .btn-period.active { background: var(--primary); color: white; border-color: var(--primary); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; margin-bottom: 0.5rem;">Trading Analyzer Pro</h1>
        <p style="text-align: center; color: #64748b; font-size: 0.85rem; max-width: 600px; margin: 0 auto 1.5rem; line-height: 1.4;">
            <strong>‚ö†Ô∏è Avertissement :</strong> Ce projet est un outil <strong>exp√©rimental</strong> et ne constitue en aucun cas un conseil en investissement. Les donn√©es sont fournies √† titre indicatif. L'√©diteur d√©cline toute responsabilit√© en cas de perte financi√®re.
        </p>

        <div class="search-box">
            <form action="{{ url_for('ultra_search') }}" method="POST" class="search-form">
                <input type="text" name="query" id="search-input" placeholder="Symbole (ex: MC.PA, AAPL)..." required autocomplete="off" value="{{ symbol|default('') }}">
                <button type="submit" class="btn-search">Analyser</button>
            </form>
            <div id="autocomplete-results" style="position:absolute; width:100%; background:white; z-index:100; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.1); display:none;"></div>
            
            <div class="sector-ticker-container">
                <div class="sector-ticker-inner">
                    {% if top_sectors %}
                        {% for sec in top_sectors %}
                        <div class="sector-badge">
                            {{ sec.name }} <span style="color: {% if sec.change|default(0) >= 0 %}var(--success){% else %}var(--danger){% endif %}; font-weight: 700;">{{ "+" if sec.change|default(0) > 0 }}{{ sec.change|default(0)|round(2) }}%</span>
                        </div>
                        {% endfor %}
                        <!-- Doubler pour un d√©filement continu sans saut -->
                        {% for sec in top_sectors %}
                        <div class="sector-badge">
                            {{ sec.name }} <span style="color: {% if sec.change|default(0) >= 0 %}var(--success){% else %}var(--danger){% endif %}; font-weight: 700;">{{ "+" if sec.change|default(0) > 0 }}{{ sec.change|default(0)|round(2) }}%</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="color: #64748b; font-size: 0.75rem; padding: 5px;">Chargement des tendances sectorielles...</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            {% if not symbol %}
            <div class="card col-12" style="text-align: center; padding: 4rem 2rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üìà</div>
                <h2>Pr√™t pour l'analyse</h2>
                <p style="color: #64748b;">Entrez un code boursier pour obtenir les signaux d'achat/vente et les graphiques.</p>
            </div>
            {% elif last_close_price is none %}
            <div class="card col-12" style="text-align: center; padding: 4rem 2rem;">
                <div class="loader" style="margin: 0 auto 1rem;"></div>
                <h2>R√©cup√©ration des donn√©es pour {{ symbol }}...</h2>
                <p>Cela peut prendre quelques secondes.</p>
                <script>setTimeout(function(){ location.reload(); }, 5000);</script>
            </div>
            {% else %}
            <div class="card col-8">
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <h2 style="margin:0;">{{ symbol }}</h2>
                        <div style="font-size: 2.5rem; font-weight: 800;">
                            {{ last_close_price|default(0)|round(2) }} {{ currency_symbol|default('‚Ç¨') }}
                        </div>
                        <div style="color: {% if daily_change_percent|default(0) > 0 %}var(--success){% else %}var(--danger){% endif %}; font-weight: 700;">
                            {{ daily_change_percent|default(0)|round(2) }}%
                        </div>
                    </div>
                    {% if recommendation %}
                    <div class="badge {% if recommendation == 'Achat' %}badge-buy{% else %}badge-sell{% endif %}" style="height: fit-content;">
                        {{ recommendation }}
                    </div>
                    {% endif %}
                </div>
                <p style="background: #f8fafc; padding: 1rem; border-radius: 12px; margin-top: 1rem; margin-bottom: 0.5rem;"><strong>Signal :</strong> {{ reason|default('Analyse technique en cours...') }}</p>
                
                <!-- Moyennes Mobiles d√©plac√©es ici -->
                <div style="display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;">
                    <div style="background: #eff6ff; border: 1px solid #dbeafe; padding: 5px 12px; border-radius: 8px; font-size: 0.8rem;">
                        <span style="color: blue; font-weight: 800;">‚óè</span> MM20: <strong>{{ mm20|round(2) if mm20 else 'N/A' }}</strong>
                    </div>
                    <div style="background: #fff7ed; border: 1px solid #ffedd5; padding: 5px 12px; border-radius: 8px; font-size: 0.8rem;">
                        <span style="color: orange; font-weight: 800;">‚óè</span> MM50: <strong>{{ mm50|round(2) if mm50 else 'N/A' }}</strong>
                    </div>
                    <div style="background: #fef2f2; border: 1px solid #fee2e2; padding: 5px 12px; border-radius: 8px; font-size: 0.8rem;">
                        <span style="color: red; font-weight: 800;">‚óè</span> MM200: <strong>{{ mm200|round(2) if mm200 else 'N/A' }}</strong>
                    </div>
                </div>

                <!-- Module de Justification -->
                <div style="background: #f1f5f9; border-left: 4px solid var(--primary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--primary);">üéØ Justification de la recommandation</h4>
                    <p style="margin: 0; font-size: 0.85rem; line-height: 1.5; color: #334155;">
                        {{ reason }}
                        <br><br>
                        <strong>Note :</strong> L'avis des analystes (actuellement : <span style="color:var(--primary)">{{ analyst_recommendation }}</span>) refl√®te souvent un objectif √† 12 mois bas√© sur les fondamentaux, tandis que notre signal est <strong>purement technique</strong> (imm√©diat). Une divergence peut appara√Ætre si le titre est techniquement surcharg√© malgr√© un bon profil financier.
                    </p>
                </div>
            </div>

            <div class="card col-4">
                <h3 style="margin-top:0;">Statistiques</h3>
                <div class="stat-item"><span class="stat-label">Secteur</span><span class="stat-val">{{ sector|default('N/A') }}</span></div>
                <div class="stat-item"><span class="stat-label">RSI (14)</span><span class="stat-val">{{ rsi_value|default(50)|round(2) }}</span></div>
                {% if pe_ratio %}
                <div class="stat-item"><span class="stat-label">P/E Ratio</span><span class="stat-val">{{ pe_ratio|round(2) }}</span></div>
                {% endif %}
                {% if div_yield %}
                <div class="stat-item"><span class="stat-label">Dividende</span><span class="stat-val">{{ div_yield|round(2) }}%</span></div>
                {% endif %}
                {% if analyst_recommendation and analyst_recommendation != 'N/A' %}
                <div class="stat-item"><span class="stat-label">Analystes</span><span class="stat-val" style="color: var(--primary);">{{ analyst_recommendation }}</span></div>
                {% endif %}
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #f1f5f9;">
                    <div class="stat-item"><span class="stat-label">Prix Entr√©e</span><span class="stat-val" style="color: var(--success);">{{ short_term_entry_price|default('N/A') }} {{ currency_symbol }}</span></div>
                    <div class="stat-item"><span class="stat-label">Objectif</span><span class="stat-val" style="color: var(--primary);">{{ short_term_exit_price|default('N/A') }} {{ currency_symbol }}</span></div>
                </div>
            </div>

            <div class="col-12">
                <button class="accordion-btn" onclick="toggleSection('chart-area')">üìä GRAPHIQUE TECHNIQUE</button>
                <div id="chart-area" class="accordion-content">
                    <div style="display: flex; align-items: flex-start;">
                        <!-- Boutons √† gauche -->
                        <div class="chart-controls">
                            <button class="btn-period" onclick="updateChartPeriod(1, 'month', this)">1M</button>
                            <button class="btn-period" onclick="updateChartPeriod(3, 'month', this)">3M</button>
                            <button class="btn-period" onclick="updateChartPeriod(6, 'month', this)">6M</button>
                            <button class="btn-period" onclick="updateChartPeriod(1, 'year', this)">1Y</button>
                            <button class="btn-period active" onclick="updateChartPeriod(0, 'all', this)">Tout</button>
                        </div>
                        <!-- Graphique √† droite -->
                        <div style="flex: 1; overflow: hidden;">
                            {{ stock_chart_div|safe }}
                        </div>
                    </div>
                </div>

                {% if news %}
                <button class="accordion-btn" style="background: #4f46e5;" onclick="toggleSection('news-area')">üì∞ ACTUALIT√âS & RAPPORTS</button>
                <div id="news-area" class="accordion-content">
                    {% for item in news %}
                    <div style="padding: 1rem; border-bottom: 1px solid #eee;">
                        <a href="{{ item.link }}" target="_blank" style="text-decoration: none; color: var(--text-main); font-weight: 600;">{{ item.title }}</a>
                        <div style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">{{ item.publisher }} ‚Ä¢ {{ item.providerPublishTime|default('') }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div> <!-- Fin de dashboard-grid -->

        <div class="col-12" style="margin-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">üó∫Ô∏è Carte thermique (√âchelle -5% / +5%)</h3>
                <div style="display: flex; gap: 10px; font-size: 0.75rem; align-items: center; background: white; padding: 5px 15px; border-radius: 99px; border: 1px solid var(--border);">
                    <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: rgba(16, 185, 129, 1); border-radius: 2px;"></span> +5%</span>
                    <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: rgba(16, 185, 129, 0.4); border-radius: 2px;"></span> Neutre</span>
                    <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: rgba(239, 68, 68, 1); border-radius: 2px;"></span> -5%</span>
                </div>
            </div>
            <div class="card heatmap-grid">
                {% if heatmap_data %}
                    {% for item in heatmap_data %}
                    {% set intensity_val = item.intensity|default(0) / 100 %}
                    <a href="/analyze?symbol={{ item.full_symbol }}" class="heatmap-tile" 
                       style="background: {% if item.change|default(0) > 0 %}rgba(16, 185, 129, {{ 0.4 + (intensity_val * 0.6) }}){% else %}rgba(239, 68, 68, {{ 0.4 + (intensity_val * 0.6) }}){% endif %};
                              color: {% if 0.4 + (intensity_val * 0.6) > 0.7 %}white{% else %}#0f172a{% endif %};">
                        {{ item.symbol }}<br><small style="font-size: 0.6rem; font-weight: 700;">{{ item.change|default(0)|round(1) }}%</small>
                    </a>
                    {% endfor %}
                {% else %}
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                        <div class="loader" style="margin: 0 auto 1rem;"></div>
                        <p style="color: #64748b;">Initialisation des donn√©es du march√© (CAC40)...</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Section Information / Menus additionnels -->
        <div class="col-12" style="margin-top: 2rem; margin-bottom: 4rem;">
            <button class="accordion-btn" style="background: #64748b;" onclick="toggleSection('info-area')">‚ÑπÔ∏è M√âTHODOLOGIE & GUIDE D'UTILISATION</button>
            <div id="info-area" class="accordion-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: var(--primary); margin-bottom: 10px;">üìä Glossaire des Indicateurs</h4>
                        <div style="font-size: 0.85rem; line-height: 1.5;">
                            <p><strong>‚Ä¢ RSI (14) :</strong> √âvalue la force du prix. Un RSI sous 40 indique une zone d'opportunit√©, au-dessus de 70 une zone de prudence.</p>
                            <p><strong>‚Ä¢ MM200 :</strong> Moyenne des 200 derniers jours. Si le cours est au-dessus, la tendance est dite "Haussi√®re".</p>
                            <p><strong>‚Ä¢ Volume Ratio :</strong> Compare les √©changes du jour √† la veille pour valider la conviction des investisseurs.</p>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: var(--primary); margin-bottom: 10px;">üéØ Comprendre les Prix Cibles</h4>
                        <div style="font-size: 0.85rem; line-height: 1.5;">
                            <p><strong>‚Ä¢ Prix d'Entr√©e :</strong> Calcul√© pour optimiser le ratio gain/risque en fonction de la volatilit√© r√©cente.</p>
                            <p><strong>‚Ä¢ Objectif :</strong> Cible de sortie court terme bas√©e sur le momentum et les r√©sistances calcul√©es.</p>
                            <p><strong>‚Ä¢ Recommandation :</strong> Synth√®se des indicateurs techniques et du consensus des analystes externes.</p>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; font-size: 0.8rem; color: #64748b; font-style: italic;">
                    Note : Les analyses sont mises √† jour toutes les 20 minutes durant les heures d'ouverture des march√©s.
                </div>
            </div>
        </div>

        <footer style="text-align: center; color: #64748b; font-size: 0.7rem; margin-top: 3rem; padding-bottom: 2rem; border-top: 1px solid var(--border); padding-top: 1rem;">
            Trading Analyzer Pro - Version {{ version|default('3.5.0') }} | Statut: {{ engine_status }} | Maj: {{ last_update }}
        </footer>
    </div>

    <script>
        function updateChartPeriod(count, unit, btn) {
            const gd = document.getElementById('main-plotly-chart');
            if (!gd) return;

            // G√©rer l'√©tat actif des boutons
            document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const now = new Date();
            let start = new Date();

            if (unit === 'month') {
                start.setMonth(now.getMonth() - count);
            } else if (unit === 'year') {
                start.setFullYear(now.getFullYear() - count);
            } else if (unit === 'all') {
                Plotly.relayout(gd, { 'xaxis.autorange': true });
                return;
            }

            Plotly.relayout(gd, {
                'xaxis.range': [start.toISOString(), now.toISOString()],
                'xaxis.autorange': false
            });
        }

        function toggleSection(id) { const e = document.getElementById(id); e.style.display = (e.style.display === 'block') ? 'none' : 'block'; }
        const input = document.getElementById('search-input');
        const res = document.getElementById('autocomplete-results');
        input.addEventListener('input', function() {
            const val = this.value.trim().toUpperCase();
            if (val.length < 1) { res.style.display = 'none'; return; }
            fetch(`/api/search_tickers?query=${val}`).then(r => r.json()).then(data => {
                res.innerHTML = '';
                if (data.length > 0) {
                    res.style.display = 'block';
                    data.forEach(s => {
                        const a = document.createElement('a'); 
                        a.href = "/analyze?symbol=" + encodeURIComponent(s.symbol);
                        a.style.display = 'block'; a.style.padding = '10px'; a.style.textDecoration = 'none'; a.style.color = '#000'; a.style.borderBottom = '1px solid #eee';
                        a.innerHTML = `<strong>${s.symbol}</strong> - ${s.name}`;
                        res.appendChild(a);
                    });
                } else { res.style.display = 'none'; }
            });
        });
    </script>
</body>
</html>