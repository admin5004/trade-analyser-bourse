<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Analyzer Pro V3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        :root { --primary: #4f46e5; --bg: #f8fafc; --card-bg: #ffffff; --text-main: #0f172a; --success: #10b981; --danger: #ef4444; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 0; }
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1.5rem; }
        .search-box { max-width: 600px; margin: 0 auto 2rem; position: relative; }
        .search-form { display: flex; gap: 10px; background: white; padding: 6px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        input[type="text"] { flex: 1; border: none; padding: 12px 20px; outline: none; font-size: 1rem; }
        button.btn-search { background: var(--primary); color: white; border: none; padding: 12px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; }
        .card { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 1.5rem; }
        .col-8 { grid-column: span 8; } .col-4 { grid-column: span 4; } .col-12 { grid-column: span 12; }
        .badge { padding: 6px 14px; border-radius: 99px; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        .badge-buy { background: #ecfdf5; color: var(--success); } .badge-sell { background: #fef2f2; color: var(--danger); }
        .stat-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .stat-label { color: #64748b; } .stat-val { font-weight: 700; }
        .accordion-btn { width: 100%; padding: 15px; background: #0f172a; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 1rem; }
        .accordion-content { display: none; margin-top: 1rem; background: white; border-radius: 20px; border: 1px solid var(--border); padding: 1rem; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .heatmap-tile { text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60px; border-radius: 8px; color: white; font-weight: 800; font-size: 0.75rem; transition: 0.2s; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center;">Trading Analyzer Pro</h1>

        <div class="search-box">
            <form action="{{ url_for('ultra_search') }}" method="POST" class="search-form">
                <input type="text" name="query" id="search-input" placeholder="Symbole (ex: MC.PA, AAPL)..." required autocomplete="off" value="{{ symbol|default('') }}">
                <button type="submit" class="btn-search">Analyser</button>
            </form>
            <div id="autocomplete-results" style="position:absolute; width:100%; background:white; z-index:100; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.1); display:none;"></div>
            
            {% if top_sectors %}
            <div style="margin-top: 1rem; display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;">
                {% for sec in top_sectors %}
                <div style="background: white; border: 1px solid var(--border); padding: 6px 12px; border-radius: 99px; font-size: 0.8rem; white-space: nowrap;">
                    {{ sec.name }} <span style="color: var(--success); font-weight: 700;">+{{ sec.change|default(0)|round(2) }}%</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="dashboard-grid">
            {% if not symbol %}
            <div class="card col-12" style="text-align: center; padding: 4rem 2rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üìà</div>
                <h2>Pr√™t pour l'analyse</h2>
                <p style="color: #64748b;">Entrez un code boursier pour obtenir les signaux d'achat/vente et les graphiques.</p>
            </div>
            {% elif not last_close_price %}
            <div class="card col-12" style="text-align: center; padding: 4rem 2rem;">
                <div class="loader" style="margin: 0 auto 1rem;"></div>
                <h2>R√©cup√©ration des donn√©es pour {{ symbol }}...</h2>
                <p>Cela peut prendre quelques secondes.</p>
                <script>setTimeout(function(){ location.reload(); }, 5000);</script>
            </div>
            {% else %}
            <div class="card col-8">
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <h2 style="margin:0;">{{ symbol }}</h2>
                        <div style="font-size: 2.5rem; font-weight: 800;">
                            {{ last_close_price|default(0)|round(2) }} {{ currency_symbol|default('‚Ç¨') }}
                        </div>
                        <div style="color: {% if daily_change_percent|default(0) > 0 %}var(--success){% else %}var(--danger){% endif %}; font-weight: 700;">
                            {{ daily_change_percent|default(0)|round(2) }}%
                        </div>
                    </div>
                    {% if recommendation %}
                    <div class="badge {% if recommendation == 'Achat' %}badge-buy{% else %}badge-sell{% endif %}" style="height: fit-content;">
                        {{ recommendation }}
                    </div>
                    {% endif %}
                </div>
                <p style="background: #f8fafc; padding: 1rem; border-radius: 12px; margin-top: 1rem;"><strong>Signal :</strong> {{ reason|default('Analyse technique en cours...') }}</p>
            </div>

            <div class="card col-4">
                <h3 style="margin-top:0;">Statistiques</h3>
                <div class="stat-item"><span class="stat-label">Secteur</span><span class="stat-val">{{ sector|default('N/A') }}</span></div>
                <div class="stat-item"><span class="stat-label">RSI (14)</span><span class="stat-val">{{ rsi_value|default(50)|round(2) }}</span></div>
                <div class="stat-item"><span class="stat-label">P/E Ratio</span><span class="stat-val">{{ pe_ratio|default('N/A') }}</span></div>
                <div class="stat-item"><span class="stat-label">Dividende</span><span class="stat-val">{{ div_yield|default('0') }}%</span></div>
            </div>

            <div class="col-12">
                <button class="accordion-btn" onclick="toggleSection('chart-area')">üìä GRAPHIQUE TECHNIQUE</button>
                <div id="chart-area" class="accordion-content">{{ stock_chart_div|safe }}</div>
            </div>
            {% endif %}
        </div> <!-- Fin de dashboard-grid -->

        <div class="col-12" style="margin-top: 2rem;">
            <h3>üó∫Ô∏è Heatmap du March√©</h3>
            <div class="card heatmap-grid">
                {% if heatmap_data %}
                    {% for item in heatmap_data %}
                    <a href="/analyze?symbol={{ item.full_symbol }}" class="heatmap-tile" 
                       style="background: {% if item.change|default(0) > 1 %}#064e3b{% elif item.change|default(0) > 0 %}#059669{% elif item.change|default(0) > -1 %}#dc2626{% else %}#7f1d1d{% endif %};">
                        {{ item.symbol }}<br><small style="font-size: 0.6rem; opacity: 0.8;">{{ item.change|default(0)|round(1) }}%</small>
                    </a>
                    {% endfor %}
                {% else %}
                    <p style="text-align:center; color: #64748b; padding: 1rem;">Chargement des donn√©es du march√©...</p>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        function toggleSection(id) { const e = document.getElementById(id); e.style.display = (e.style.display === 'block') ? 'none' : 'block'; }
        const input = document.getElementById('search-input');
        const res = document.getElementById('autocomplete-results');
        input.addEventListener('input', function() {
            const val = this.value.trim().toUpperCase();
            if (val.length < 1) { res.style.display = 'none'; return; }
            fetch(`/api/search_tickers?query=${val}`).then(r => r.json()).then(data => {
                res.innerHTML = '';
                if (data.length > 0) {
                    res.style.display = 'block';
                    data.forEach(s => {
                        const a = document.createElement('a'); 
                        a.href = "/analyze?symbol=" + encodeURIComponent(s.symbol);
                        a.style.display = 'block'; a.style.padding = '10px'; a.style.textDecoration = 'none'; a.style.color = '#000'; a.style.borderBottom = '1px solid #eee';
                        a.innerHTML = `<strong>${s.symbol}</strong> - ${s.name}`;
                        res.appendChild(a);
                    });
                } else { res.style.display = 'none'; }
            });
        });
    </script>
</body>
</html>